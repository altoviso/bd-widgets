<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <script src="../node_modules/bd-smoke/smoke.js"></script>
    <script src="./manifest.js"></script>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <title>Backdraft Widgets Test Page</title>
    <style type="text/css">
        #help {
            margin: 1em;
        }
        table {
            border-collapse: collapse;
        }
        td {
            padding: 5px;
            border: 1px solid black;
        }
        .code {
            font-family: monospace;
            font-weight: bold;
            font-size:90%;
        }
        p.code {
            background-color:#111111;
            color:lightgreen;
            padding:1em;
        }
    </style>
</head>

<body>
<noscript>
    You need to enable JavaScript to run this app.
</noscript>
<div id="help">
    <h1>Backdraft Widget Test Page</h1>
    <p>This page loads the tests given in <span class="code">./manifest.js</span> and then executes one, some, or all of those tests.</p>
    <p>URL query parameters control what tests are loaded and executed as follows:</p>
    <table>
        <tr>
            <th>Param</th>
            <th>Desciption</th>
            <th>Default</th>
        </tr>
        <tr>
            <td class="code">test</td>
            <td>comma-separated list of tests to load from the manifest</td>
            <td>all tests are loaded</td>
        </tr>
        <tr>
            <td class="code">run</td>
            <td>comma-separated list of test id's to execute</td>
            <td>no tests are executed</td>
        </tr>
        <tr>
            <td class="code">css</td>
            <td>comma-separated list CSS resources to load</td>
            <td><span class="code">../less/main.css</span> is loaded</td>
        </tr>
        <tr>
            <td class="code">liveCss</td>
            <td>the port to locate the CSS live reloader</td>
            <td>live reloader is not loaded</td>
        </tr>
    </table>

    <p><span class="code">window.smoke</span> gives the smoke test harness object. Tests may be run from the console:</p>
    <p class="code">window.smoke.run(<i>test-name</i>) </p>
    <p>Test may be run from selenium webdriver:</p>
    <p class="code">driver.executeAsyncScript("window.runRemote(<i>test-name</i>)") </p>
    <h2>Click anywhere in these instructions to remove them.</h2>
</div>
<div id="root"></div>
<script id="page-config">
	(function(){
		let helpNode = document.getElementById("help");
		helpNode.addEventListener("click", () => helpNode.parentNode.removeChild(helpNode));

		let toArray = src => Array.isArray(src) ? src : [src];
		let commaListToArray = src => src.split(",").map(s=>s.trim()).filter(s=>!!s);
		let conditionArrayOfCommaListOptions = src => toArray(src).reduce((result, item)=>result.concat(commaListToArray(item)), []);
		let inject = (src, injector) => toArray(src).map(url => injector(url));

		smoke.configureBrowser();
		let options = smoke.options;
		if(!options.css){
			options.css = ["../less/main.css"];
		}else{
			options.css = conditionArrayOfCommaListOptions(options.css);
        }
		if(!options.test){
			options.test = Object.keys(smoke.options.user.testModules);
		}else{
			options.test = conditionArrayOfCommaListOptions(options.test);
		}

		Promise.all(
			inject(options.liveCss ? "//localhost:" + options.liveCss + "/livereload.js" : [], smoke.injectScript).concat(
				inject(options.css, smoke.injectCss).concat(
					inject(options.test, (test) => smoke.injectScript(smoke.options.user.testModules[test], "module"))
				)
			)
		).then(() =>{
			let run = options.run;
			if(run){
				run = conditionArrayOfCommaListOptions(run);
				Promise.all(run.map(test => smoke.run(test))).then(
					(loggers) =>{
						// all the loggers are the same object--smoke.options.logger
						let logger = loggers[0];
						console.log("        total:" + logger.totalCount);
						console.log("         pass:" + logger.passCount);
						console.log("         fail:" + logger.failCount);
						console.log("scaffold fail:" + logger.scaffoldFailCount);
					}
				);
			}
		}).catch((e) =>{
			console.log(e);
			console.log(e.stack);
		});
	})()
</script>
</body>
</html>